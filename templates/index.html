<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chulas of Poshpora</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="static/style.css"> 
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-4">
    <a class="navbar-brand" href="#">Chulas of Poshpora</a>
    <div class="navbar-nav ms-auto">
      {% if is_admin %}
        <a class="nav-link" href="/logout">Logout</a>
      {% else %}
        <a class="nav-link" href="/login">Admin Login</a>
      {% endif %}
    </div>
  </nav>

  <div class="container mt-4">
    <!-- Admin-only Add New Chula Form -->
    {% if is_admin %}
    <div class="card mb-4">
      <div class="card-header">Add New Chula</div>
      <div class="card-body">
        <form id="chulaForm" class="row g-3">
          <div class="col-md-4">
            <input type="text" id="name" class="form-control" placeholder="Chula Name" required>
          </div>
          <div class="col-md-4">
            <input type="text" id="head" class="form-control" placeholder="Chula Head">
          </div>
          <div class="col-md-4">
            <input type="text" id="members" class="form-control" placeholder="Members (comma separated)" required>
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-primary">Add Chula</button>
          </div>
        </form>
      </div>
    </div>
    {% else %}
    <div class="alert alert-info">
      <strong>Note:</strong> You need to <a href="/login" class="alert-link">login as admin</a> to add or edit chulas.
    </div>
    {% endif %}

    <h3 class="mb-3">All Chulas</h3>
    <div id="chula-list" class="row g-3">
      <div class="col-12 text-center">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Chula Modal (Admin only) -->
  {% if is_admin %}
  <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="editChulaForm">
          <div class="modal-header">
            <h5 class="modal-title">Edit Chula</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editChulaId">
            <div class="mb-3">
              <label for="editName" class="form-label">Chula Name</label>
              <input type="text" id="editName" class="form-control" placeholder="Chula Name" required>
            </div>
            <div class="mb-3">
              <label for="editHead" class="form-label">Chula Head</label>
              <input type="text" id="editHead" class="form-control" placeholder="Chula Head">
            </div>
            <div class="mb-3">
              <label for="editMembers" class="form-label">Members</label>
              <textarea id="editMembers" class="form-control" rows="3" placeholder="Members (comma-separated)" required></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_URL = "/api/chulas";
    const isAdmin = {{ is_admin|tojson }};

    // Load and display chulas
    function loadChulas() {
      fetch(API_URL)
        .then(res => {
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          return res.json();
        })
        .then(data => {
          console.log('Loaded chulas:', data); // Debug log
          const container = document.getElementById('chula-list');
          container.innerHTML = '';

          if (!data || data.length === 0) {
            container.innerHTML = `
              <div class="col-12">
                <p class='text-muted text-center'>No chulas added yet.</p>
              </div>
            `;
            return;
          }

          data.forEach(chula => {
            const div = document.createElement('div');
            div.className = 'col-md-6';
            
            // Handle members display
            let membersDisplay = 'N/A';
            if (chula.members && Array.isArray(chula.members) && chula.members.length > 0) {
              membersDisplay = chula.members.join(', ');
            } else if (chula.members && typeof chula.members === 'string') {
              membersDisplay = chula.members;
            }

            div.innerHTML = `
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">${chula.name}</h5>
                  <p class="card-text"><strong>Head:</strong> ${chula.head || 'N/A'}</p>
                  <p class="card-text"><strong>Members:</strong> ${membersDisplay}</p>
                  ${isAdmin ? `
                    <button class="btn btn-sm btn-outline-primary me-2" onclick='openEditModal(${JSON.stringify(chula)})'>Edit</button>
                    <button class="btn btn-sm btn-outline-danger" onclick='deleteChula(${chula.id})'>Delete</button>
                  ` : ''}
                </div>
              </div>
            `;
            container.appendChild(div);
          });
        })
        .catch(err => {
          console.error("Error loading chulas:", err);
          const container = document.getElementById('chula-list');
          container.innerHTML = `
            <div class="col-12">
              <div class="alert alert-danger">
                <strong>Error loading chulas:</strong> ${err.message}
              </div>
            </div>
          `;
        });
    }

    // Handle Add Form (Admin only)
    if (isAdmin) {
      const form = document.getElementById('chulaForm');
      if (form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          const name = document.getElementById('name').value.trim();
          const head = document.getElementById('head').value.trim();
          const members = document.getElementById('members').value.trim();

          if (!name) {
            alert('Chula name is required!');
            return;
          }

          fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, head, members })
          })
          .then(res => {
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
          })
          .then(data => {
            alert(data.message || "Chula added!");
            form.reset();
            loadChulas();
          })
          .catch(err => {
            console.error("Error adding chula:", err);
            alert("Error adding chula: " + err.message);
          });
        });
      }

      // Edit modal functions
      window.openEditModal = function(chula) {
        document.getElementById('editChulaId').value = chula.id;
        document.getElementById('editName').value = chula.name;
        document.getElementById('editHead').value = chula.head || '';
        
        // Handle members display in edit form
        let membersText = '';
        if (chula.members && Array.isArray(chula.members)) {
          membersText = chula.members.join(', ');
        } else if (chula.members && typeof chula.members === 'string') {
          membersText = chula.members;
        }
        document.getElementById('editMembers').value = membersText;

        let modal = new bootstrap.Modal(document.getElementById('editModal'));
        modal.show();
      }

      // Handle Edit Form
      const editForm = document.getElementById('editChulaForm');
      if (editForm) {
        editForm.addEventListener('submit', function(e) {
          e.preventDefault();
          let id = document.getElementById('editChulaId').value;
          let data = {
            name: document.getElementById('editName').value.trim(),
            head: document.getElementById('editHead').value.trim(),
            members: document.getElementById('editMembers').value.trim()
          };

          fetch(`${API_URL}/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          })
          .then(res => {
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
          })
          .then(() => {
            loadChulas();
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
            alert('Chula updated successfully!');
          })
          .catch(err => {
            console.error("Error updating chula:", err);
            alert("Error updating chula: " + err.message);
          });
        });
      }

      // Delete function
      window.deleteChula = function(id) {
        if (confirm('Are you sure you want to delete this chula?')) {
          fetch(`${API_URL}/${id}`, {
            method: 'DELETE'
          })
          .then(res => {
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
          })
          .then(() => {
            alert('Chula deleted successfully!');
            loadChulas();
          })
          .catch(err => {
            console.error("Error deleting chula:", err);
            alert("Error deleting chula: " + err.message);
          });
        }
      }
    }

    // Initial load
    loadChulas();
  </script>
</body>
</html>